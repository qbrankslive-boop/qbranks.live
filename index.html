
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>qbranks.live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet"> 
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; 
        overflow: hidden; 
        background: #0f172a; 
        color: #e2e8f0; 
    }

    #map { height: 100vh; width: 100vw; }
    .leaflet-tooltip { background-color: rgba(15, 23, 42, 0.95); border: 2px solid #3b82f6; border-radius: 6px; padding: 6px 12px; font-weight: 600; font-size: 13px; color: white; box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
    .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); background: linear-gradient(135deg,#1e293b 0%,#0f172a 100%); border: 1px solid rgba(59,130,246,0.3); }
    .leaflet-popup-content { margin: 20px; font-size: 14px; line-height: 1.6; color: #e2e8f0; }
    .leaflet-popup-tip { background: #1e293b; }
    .popup-title { font-size: 20px; font-weight: bold; color: #60a5fa; margin-bottom: 12px; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; text-shadow: 0 0 10px rgba(59,130,246,0.5); }
    .popup-stats { display: grid; grid-template-columns: auto 1fr; gap: 10px 16px; margin-top: 12px; }
    .popup-label { font-weight: 600; color: #94a3b8; }
    .popup-value { color: #e2e8f0; }
    .rank-badge { display:inline-block; background:linear-gradient(135deg,#8b5cf6 0%,#6366f1 100%); color:white; padding:5px 12px; border-radius:14px; font-weight:bold; font-size:13px; box-shadow: 0 2px 8px rgba(139,92,246,0.4); }
    .score-badge { display:inline-block; background:linear-gradient(135deg,#ec4899 0%,#f97316 100%); color:white; padding:5px 12px; border-radius:14px; font-weight:bold; font-size:13px; box-shadow:0 2px 8px rgba(236,72,153,0.4); }
    
    .control-panel { 
        position: absolute; top: 20px; left: 70px; 
        background: linear-gradient(135deg,#1e293b 0%,#0f172a 100%); 
        padding: 20px; 
        border-radius: 12px; 
        box-shadow: 0 6px 24px rgba(0,0,0,0.5); 
        z-index:1000; 
        max-width: 300px; 
        max-height: 95vh;
        overflow-y: auto;
        border: 1px solid rgba(59,130,246,0.3); 
        backdrop-filter: blur(10px); 
        color: #e2e8f0; 
        transition: all 0.3s ease;
    }

    /* Scrollbar for control panel */
    .control-panel::-webkit-scrollbar { width: 6px; }
    .control-panel::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); border-radius: 3px; }
    .control-panel::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
    .control-panel::-webkit-scrollbar-thumb:hover { background: #60a5fa; }

    .control-panel h2 { margin:0 0 15px 0; font-size:22px; color:#60a5fa; border-bottom:3px solid #3b82f6; padding-bottom:8px; }
    .control-group { margin-bottom: 10px; }
    .control-group label { display:block; font-weight:600; margin-bottom:6px; color:#94a3b8; font-size:13px; }
    .control-group select, .control-group input { width:100%; padding:8px 12px; border:2px solid rgba(59,130,246,0.3); border-radius:6px; font-size:13px; transition:all 0.3s; background: rgba(15,23,42,0.8); color: #e2e8f0; }
    .control-group select:focus, .control-group input:focus { outline:none; border-color:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
    .control-group input::placeholder { color:#64748b; }
    
    /* Stats Summary Styling */
    .stats-summary { 
        background: linear-gradient(135deg,#8b5cf6 0%,#6366f1 100%); 
        color:white; 
        padding:12px; 
        border-radius:8px; 
        margin-top:15px; 
        font-size:13px; 
        line-height:1.6; 
        box-shadow:0 4px 12px rgba(139,92,246,0.4); 
    }
    .stats-summary strong { font-size:16px; }
    /* Missing Teams List Styling */
    .missing-teams-list {
        margin-top: 8px;
        padding: 5px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        font-size: 11px;
        list-style: none; /* Remove bullet points */
        padding-left: 10px;
        border-left: 3px solid #f97316;
        color: #fef3c7; /* Light text for visibility */
    }
    .missing-teams-list li {
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Settings button style (Now a hamburger) */
    #toggleSettings { 
        position:absolute; 
        top:20px; 
        left:20px; 
        background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%); 
        border:none; 
        padding:10px 14px; 
        border-radius:8px; 
        cursor:pointer; 
        font-size:18px; 
        color:white; 
        box-shadow:0 4px 12px rgba(59,130,246,0.4); 
        z-index:1001; 
        transition:all 0.3s; 
    }

    /* Rankings button style (The second hamburger) */
    #toggleRankings { 
        position: absolute; 
        top: 20px; 
        right: 20px; 
        background: linear-gradient(135deg,#ec4899 0%,#f97316 100%); 
        border: none; 
        padding: 10px 14px; 
        border-radius: 8px; 
        cursor: pointer; 
        font-size: 18px; 
        color: white; 
        box-shadow: 0 4px 12px rgba(236,72,153,0.4); 
        z-index: 1001; 
        transition: all 0.3s;
        transform: translate(0, 0); 
    }

    /* Rankings Panel positioning relative to its toggle button */
    .rankings-panel { 
        position:absolute; 
        top:70px; 
        right:20px; 
        background: linear-gradient(135deg,#1e293b 0%,#0f172a 100%); 
        padding:18px; 
        border-radius:10px; 
        box-shadow:0 6px 24px rgba(0,0,0,0.5); 
        z-index:1000; 
        max-width:300px; 
        max-height:80vh; 
        overflow-y:auto; 
        border: 1px solid rgba(59,130,246,0.3); 
        color:#e2e8f0; 
        transition: all 0.3s ease;
    }

    .rankings-panel h3 { margin:0 0 12px 0; font-size:16px; color:#60a5fa; border-bottom:2px solid #3b82f6; padding-bottom:6px; }
    
    /* Individual Team Ranking Item */
    .ranking-item { 
        display:flex; justify-content:space-between; align-items:center; 
        padding:8px; margin-bottom:6px; 
        background: rgba(59,130,246,0.06); border-radius:6px; 
        cursor:pointer; transition:all 0.2s; 
        border:1px solid transparent; color:#e2e8f0; 
    }
    .ranking-item:hover { background: rgba(59,130,246,0.12); border-color:#3b82f6; transform: translateX(3px); }
    
    /* Style for the selected item */
    .ranking-item.selected { 
        background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%); 
        color: white !important; 
        font-weight: bold; 
        box-shadow: 0 4px 10px rgba(59,130,246,0.6);
    }
    .ranking-item.selected .ranking-team,
    .ranking-item.selected .ranking-number,
    .ranking-item.selected .ranking-score {
        color: white !important; 
    }

    .ranking-number { font-weight:bold; color:#60a5fa; font-size:14px; min-width:25px; }
    .ranking-team { flex:1; margin:0 8px; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ranking-score { font-weight:bold; color:#ec4899; font-size:13px; }
    .filter-section { margin-bottom:10px; padding:10px; background: rgba(59,130,246,0.06); border-radius:6px; border:1px solid rgba(59,130,246,0.08); }
    .filter-section h4 { margin:0 0 8px 0; font-size:13px; color:#60a5fa; font-weight:600; }
    .checkbox-group { display:flex; align-items:center; margin-bottom:6px; }
    .checkbox-group input[type="checkbox"] { margin-right:6px; width:16px; height:16px; cursor:pointer; }
    .checkbox-group label { margin:0; cursor:pointer; color:#cbd5e1; font-size:12px; }
    .rankings-panel::-webkit-scrollbar { width:6px; }
    .rankings-panel::-webkit-scrollbar-track { background: rgba(15,23,42,0.5); border-radius:3px; }
    .rankings-panel::-webkit-scrollbar-thumb { background: #3b82f6; border-radius:3px; }
    .rankings-panel::-webkit-scrollbar-thumb:hover { background: #60a5fa; }
    
    /* search suggestions (Scrollable with max-height) */
    .suggestions { 
        position: absolute; 
        z-index: 1500; 
        background: linear-gradient(135deg,#fff 0%,#f1f5f9 100%); 
        border-radius:6px; 
        border:1px solid rgba(59,130,246,0.2); 
        overflow: hidden; 
        max-height: 200px; 
        overflow-y: auto; 
        box-shadow:0 8px 20px rgba(0,0,0,0.2); 
    }
    .suggestions::-webkit-scrollbar { width: 6px; }
    .suggestions::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .suggestions::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    .suggestions::-webkit-scrollbar-thumb:hover { background: #64748b; }

    .suggestion-item { padding:6px 10px; cursor:pointer; font-size:13px; color:#0f172a; border-bottom:1px solid rgba(0,0,0,0.05); }
    .suggestion-item:hover { background: rgba(59,130,246,0.08); color:#0f172a; }
    /* make sure suggestion placed relative to search input */
    .search-wrapper { position: relative; }

    /* Loading text style */
    .loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%); padding:30px 50px; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.5); z-index:2000; font-size:18px; font-weight:bold; color:#60a5fa; border:1px solid rgba(59,130,246,0.3); animation:pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { opacity:1 } 50% { opacity:0.7 } }
    .hidden { display:none; }

    /* New styles for Circuit Tables and Accolades */
    .circuit-table { 
        width: 100%; 
        border-collapse: collapse; 
        font-size: 12px;
        color: #e2e8f0;
    }
    .circuit-table th {
        padding: 6px 4px;
        text-align: left;
        color: #60a5fa;
        border-bottom: 2px solid #3b82f6;
    }
    .circuit-table td {
        padding: 5px 4px;
        border-bottom: 1px solid rgba(59,130,246,0.1);
        white-space: nowrap;
    }
    .circuit-table td:nth-child(2) {
        font-weight: 600; /* Bold the circuit/state name */
    }

    .accolade-item {
        padding: 8px 0;
        line-height: 1.4;
        font-size: 13px;
        border-bottom: 1px solid rgba(59,130,246,0.3);
    }
    .accolade-item:last-child {
        border-bottom: none;
    }
    .accolade-title {
        font-weight: bold;
        color: #f97316;
        display: block;
        margin-bottom: 4px;
    }
    .accolade-detail {
        color: #cbd5e1;
    }

  </style>
</head>
<body>

<button id="toggleSettings" onclick="togglePanel()">‚ò∞</button>
<button id="toggleRankings" onclick="toggleRankingsPanel()">‚ò∞</button>

<div id="controlPanel" class="control-panel">
  <h2>qbranks.live</h2>

  <div class="control-group search-wrapper">
    <label>Search Team</label>
    <input type="text" id="teamSearch" placeholder="Type team name..." oninput="handleSearchInput()" autocomplete="off">
    <div id="suggestions" class="suggestions hidden"></div>
  </div>

  <div class="filter-section">
    <h4>Visual Settings</h4>

    <div class="checkbox-group" style="margin-bottom: 12px;">
      <input type="checkbox" id="darkMode" checked onchange="toggleDarkMode()">
      <label for="darkMode">Dark Mode</label>
    </div>

    <div class="control-group">
      <label>Color Scheme</label>
      <select id="colorScheme" onchange="updateColors()">
        <option value="random">Random Colors</option>
        <option value="rank">Color by Rank</option>
        <option value="score">Color by Score</option>
      </select>
    </div>

    <div class="control-group">
      <label>Circle Size Mode</label>
      <select id="sizeMode" onchange="updateSizes()">
        <option value="score">By Score</option>
        <option value="uniform">Uniform</option>
      </select>
    </div>

    <div class="control-group">
      <label>Circle Radius Multiplier (<span id="radiusVal">1.0</span>x)</label>
      <input type="range" id="radiusSlider" min="0.2" max="4" step="0.1" value="1" oninput="handleRadiusSlider()" onchange="updateSizes()">
    </div>
  </div>

  <div class="filter-section">
    <h4>Rank Filter</h4>
    <div class="control-group">
      <label>Show Top X teams (leave empty to show all)</label>
      <input type="number" id="topX" placeholder="e.g. 100" min="1" oninput="filterByRank()" />
    </div>
  </div>

  <div class="filter-section">
    <h4>Grade Level Filter</h4> 
    <div class="checkbox-group">
      <input type="checkbox" id="gradeHS" checked onchange="handleGradeToggle()">
      <label for="gradeHS">High School (HS)</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="gradeMS" checked onchange="handleGradeToggle()">
      <label for="gradeMS">Middle/Elementary (MS/ES)</label>
    </div>
  </div>

  <div class="stats-summary" id="statsSummary">
    <strong>Loading data...</strong>
  </div>
</div>

<div class="rankings-panel" id="rankingsPanel">
  <div class="control-group" style="margin-bottom: 15px;">
    <label>Ranking View</label>
    <select id="rankingViewSelect" onchange="switchRankingView(this.value)">
        <option value="overall">Overall Team Rankings</option>
        <option value="hs_circuit">HS State Rankings</option>
        <option value="ms_circuit">MS State Rankings</option>
        <option value="accolades">Accolades</option>
    </select>
  </div>
  
  <div id="overallRankingsContent">
      <h3>Overall Team Rankings</h3>
      <div id="topRankings"></div>
  </div>

  <div id="hsCircuitRankingsContent" class="hidden">
      <h3>HS State Rankings</h3>
      <div id="hsCircuitRankings"></div>
  </div>

  <div id="msCircuitRankingsContent" class="hidden">
      <h3>MS State Rankings</h3>
      <div id="msCircuitRankings"></div>
  </div>

  <div id="accoladesContent" class="hidden">
      <h3>Accolades</h3>
      <div id="accoladesList"></div>
  </div>

</div>

<div id="loading" class="loading">Loading Quizbowl Data...</div>

<div id="map"></div>

<script>
/* ---------- Config / sheet links ---------- */
// **CHANGE THIS TO YOUR ACTUAL SHEET ID**
const SHEET_ID = "1ZiV-l0X4Hlvice0GX7CJZ5YGlXodMcdCNRGVanVzlaA"; 
const LOCATION_SHEET = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Location%20Data`;
// default overall sheet (all)
const OVERALL_SHEET_DEFAULT = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Overall`;
// HS-only and MS-only based on user-provided gids:
const OVERALL_SHEET_HS = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=39357228`;
const OVERALL_SHEET_MS = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=1050804017`;

/* ---------- Static Circuit and Accolade Data ---------- */
// Utility function to convert 2-letter codes to full names
function getCircuitFullName(code) {
    const map = {
        'MA': 'Massachusetts', 'IL': 'Illinois', 'TX': 'Texas', 'GA': 'Georgia', 'CA': 'California',
        'LA': 'Louisiana', 'MD': 'Maryland', 'IN': 'Indiana', 'NC': 'North Carolina', 'VA': 'Virginia',
        'AL': 'Alabama', 'MN': 'Minnesota', 'NJ': 'New Jersey', 'MI': 'Michigan', 'MO': 'Missouri',
        'PA': 'Pennsylvania', 'FL': 'Florida', 'OK': 'Oklahoma', 'NY': 'New York', 'OH': 'Ohio',
        'WA': 'Washington', 'TN': 'Tennessee', 'KY': 'Kentucky', 'CT': 'Connecticut', 'NE': 'Nebraska',
        'SC': 'South Carolina', 'DE': 'Delaware', 'CO': 'Colorado', 'ID': 'Idaho', 'AR': 'Arkansas',
        'DC': 'District of Columbia', 'ME': 'Maine', 'NH': 'New Hampshire', 'MS': 'Mississippi',
        'WV': 'West Virginia', 'ON': 'Ontario (Canada)', 'NM': 'New Mexico', 'WI': 'Wisconsin',
        'CR': 'Costa Rica', 'AB': 'Alberta (Canada)', 'ROK': 'South Korea', 'NV': 'Nevada',
        'South Korea': 'South Korea' // Ensure non-code values pass through
    };
    return map[code] || code;
}

const hsCircuitData = [
    { rank: 1, circuit: 'MA', strength: 18.05 }, { rank: 2, circuit: 'IL', strength: 16.82 },
    { rank: 3, circuit: 'TX', strength: 16.42 }, { rank: 4, circuit: 'GA', strength: 16.20 },
    { rank: 5, circuit: 'CA', strength: 15.48 }, { rank: 6, circuit: 'LA', strength: 15.40 },
    { rank: 7, circuit: 'MD', strength: 15.23 }, { rank: 8, circuit: 'IN', strength: 14.91 },
    { rank: 9, circuit: 'NC', strength: 14.81 }, { rank: 10, circuit: 'VA', strength: 14.76 },
    { rank: 11, circuit: 'AL', strength: 14.73 }, { rank: 12, circuit: 'MN', strength: 14.64 },
    { rank: 13, circuit: 'NJ', strength: 14.57 }, { rank: 14, circuit: 'MI', strength: 14.56 },
    { rank: 15, circuit: 'MO', strength: 14.43 }, { rank: 16, circuit: 'PA', strength: 14.28 },
    { rank: 17, circuit: 'FL', strength: 14.07 }, { rank: 18, circuit: 'OK', strength: 14.02 },
    { rank: 19, circuit: 'NY', strength: 13.96 }, { rank: 20, circuit: 'OH', strength: 13.92 },
    { rank: 21, circuit: 'WA', strength: 13.53 }, { rank: 22, circuit: 'TN', strength: 13.43 },
    { rank: 23, circuit: 'KY', strength: 13.20 }, { rank: 24, circuit: 'CT', strength: 12.93 },
    { rank: 25, circuit: 'NE', strength: 12.91 }, { rank: 26, circuit: 'SC', strength: 12.84 },
    { rank: 27, circuit: 'DE', strength: 12.55 }, { rank: 28, circuit: 'CO', strength: 12.49 },
    { rank: 29, circuit: 'South Korea', strength: 12.46 }, { rank: 30, circuit: 'ID', strength: 11.82 },
    { rank: 31, circuit: 'AR', strength: 11.73 }, { rank: 32, circuit: 'DC', strength: 11.73 },
    { rank: 33, circuit: 'ME', strength: 11.72 }, { rank: 34, circuit: 'NH', strength: 11.69 },
    { rank: 35, circuit: 'MS', strength: 11.52 }, { rank: 36, circuit: 'WV', strength: 11.33 },
    { rank: 37, circuit: 'ON', strength: 11.32 }, { rank: 38, circuit: 'NM', strength: 11.17 },
    { rank: 39, circuit: 'WI', strength: 9.50 }, { rank: 40, circuit: 'CR', strength: 9.28 },
    { rank: 41, circuit: 'AB', strength: 8.12 }
].map(c => ({...c, circuit: getCircuitFullName(c.circuit)})); // Map to full names

const msCircuitData = [
    { rank: 1, circuit: 'TX', strength: 10.26 }, { rank: 2, circuit: 'GA', strength: 9.97 },
    { rank: 3, circuit: 'CA', strength: 9.48 }, { rank: 4, circuit: 'NJ', strength: 9.35 },
    { rank: 5, circuit: 'IN', strength: 8.80 }, { rank: 6, circuit: 'NY', strength: 8.77 },
    { rank: 7, circuit: 'VA', strength: 8.72 }, { rank: 8, circuit: 'ROK', strength: 8.28 },
    { rank: 9, circuit: 'CT', strength: 8.18 }, { rank: 10, circuit: 'MD', strength: 8.11 },
    { rank: 11, circuit: 'IL', strength: 7.99 }, { rank: 12, circuit: 'KY', strength: 7.91 },
    { rank: 13, circuit: 'NV', strength: 7.88 }, { rank: 14, circuit: 'NC', strength: 7.74 },
    { rank: 15, circuit: 'FL', strength: 7.52 }, { rank: 16, circuit: 'WA', strength: 7.28 },
    { rank: 17, circuit: 'OH', strength: 6.91 }, { rank: 18, circuit: 'PA', strength: 6.85 },
    { rank: 19, circuit: 'LA', strength: 6.80 }, { rank: 20, circuit: 'DC', strength: 6.65 },
    { rank: 21, circuit: 'WI', strength: 5.88 }, { rank: 22, circuit: 'TN', strength: 5.51 },
    { rank: 23, circuit: 'CO', strength: 5.32 }, { rank: 24, circuit: 'OK', strength: 5.05 },
    { rank: 25, circuit: 'MA', strength: 4.16 }
].map(c => ({...c, circuit: getCircuitFullName(c.circuit)})); // Map to full names

const accoladesData = [
    { title: "Best Team", detail: "Lexington A (99.02, #1)" },
    { title: "Best Team on NAQT", detail: "Northview A (92.3, #3)" },
    { title: "Best Team on mACF", detail: "Adlai E. Stevenson A (92.78, #2)" },
    { title: "Best MS Team", detail: "Riverwatch A (68.30, #146)" },
    { title: "Best MS Team on NAQT", detail: "St. Mark's School of Texas Middle A (66.97, #173)" },
    { title: "Best MS Team on mACF", detail: "Smith A (62.86, #269)" },
    { title: "Best Tournament Director", detail: "Scott Kim (North by North Gwinnett IX, 56 teams)" },
    { title: "Best Circuit (HS)", detail: `Massachusetts, Strength: 18.05` },
    { title: "Best Circuit (MS)", detail: `Texas, Strength: 10.24` },
    { title: "Best HS Rivalry", detail: "University School of Nashville A vs White Station A" },
    { title: "Best MS Rivalry", detail: "Hopkins A vs Redwood A" }
];
/* ---------- END Static Circuit and Accolade Data ---------- */

/* ---------- Globals ---------- */
let map;
let currentTileLayer;
let allTeams = [];     // { name, lat, lon, score, rank, location, rawScoreRow }
let circles = [];      // { circle, name, score, rank, lat, lon }
let markerLayerGroup = L.layerGroup();
let radiusMultiplier = 1.0;
// Global variable to hold missing teams list for UI rendering
let teamsMissingLocationGlobal = []; 

/* ---------- init ---------- */
window.addEventListener('load', function() {
  map = L.map('map').setView([39, -95], 4);
  currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 18,
    attribution: '¬© OpenStreetMap contributors, ¬© CARTO'
  }).addTo(map);
  markerLayerGroup.addTo(map);
  loadData();
  // Initialize the static ranking views
  renderCircuitRankings(hsCircuitData, 'hsCircuitRankings');
  renderCircuitRankings(msCircuitData, 'msCircuitRankings');
  renderAccolades(accoladesData, 'accoladesList');
});

/* ---------- helper: create tile layer for dark/light ---------- */
function createTileLayer(isDark) {
  if (currentTileLayer) { map.removeLayer(currentTileLayer); }
  if (isDark) {
    currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18, attribution: '¬© OpenStreetMap contributors, ¬© CARTO' }).addTo(map);
  } else {
    currentTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '¬© OpenStreetMap contributors' }).addTo(map);
  }
}

/* ---------- CSV loader ---------- */
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => resolve(results.data),
      error: (err) => reject(err)
    });
  });
}

/* ---------- utility: normalize text for fuzzy matching ---------- */
function normalize(str) {
  if (!str) return '';
  return String(str).trim().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'');
}

/* ---------- clear existing markers/arrays ---------- */
function clearData() {
  allTeams = [];
  circles.forEach(c => {
    try { markerLayerGroup.removeLayer(c.circle); } catch(e) {}
  });
  circles = [];
  markerLayerGroup.clearLayers();
  document.getElementById('topRankings').innerHTML = '';
  teamsMissingLocationGlobal = []; // Clear the global list
}

/* ---------- get proper overall sheet URL based on grade toggles ---------- */
function getOverallURL() {
  const hs = document.getElementById('gradeHS').checked;
  const ms = document.getElementById('gradeMS').checked;
  // If both checked -> show combined (default)
  if (hs && !ms) return OVERALL_SHEET_HS;
  if (!hs && ms) return OVERALL_SHEET_MS;
  return OVERALL_SHEET_DEFAULT;
}

/* ---------- reload data when grade toggles change ---------- */
function handleGradeToggle() {
  // reload dataset according to selected grade(s)
  refreshData();
}

/* ---------- refresh: clear and load ---------- */
async function refreshData() {
  clearData();
  document.getElementById('loading').classList.remove('hidden');
  await loadData();
}

async function loadData() {
  try {
    const locUrl = LOCATION_SHEET;
    const overallUrl = getOverallURL();
    console.log('Loading:', locUrl, overallUrl);

    const [locData, scoreData] = await Promise.all([ loadCSV(locUrl), loadCSV(overallUrl) ]);

    const possibleNameCols = ["Team","Team Name","School","School Name","Name"];
    let teamColumnName = null;
    if (scoreData.length > 0) {
      for (let col of possibleNameCols) {
        if (scoreData[0].hasOwnProperty(col)) { teamColumnName = col; break; }
      }
    }
    if (!teamColumnName) {
      console.warn('No team name column found in score data. Using first column as fallback.');
      teamColumnName = Object.keys(scoreData[0])[0];
    }
    const bestSetNames = ["Best Set","Best Set Name","Best Set(s)","Best_Set","BestSet"];
    function findColCandidate(rowSample, candidates) {
      for (let cand of candidates) {
        if (rowSample.hasOwnProperty(cand)) return cand;
      }
      const keys = Object.keys(rowSample);
      for (let cand of candidates) {
        const lc = cand.toLowerCase().replace(/\W/g,'');
        for (let k of keys) {
          if (k.toLowerCase().replace(/\W/g,'') === lc) return k;
        }
      }
      return null;
    }
    const bestSetCol = scoreData.length ? findColCandidate(scoreData[0], bestSetNames) : null;
    const bestTournCol = null; 
    const locationMap = {};
    for (const row of locData) {
        const name = (row["Team Name"] || row["Team"] || row["Name"] || '').trim();
        if (name) locationMap[name] = row;
    }
    let maxScore = 0;
    for (const row of scoreData) {
      const s = parseFloat(row.Score);
      if (!isNaN(s)) maxScore = Math.max(maxScore, s);
    }
    
    let teamsMissingLocation = []; 

    for (const scoreRow of scoreData) {
        const name = String(scoreRow[teamColumnName] || '').trim();
        if (!name) continue;

        let teamRow = locationMap[name];
        
        if (!teamRow) {
            const normalizedName = normalize(name);
            for (const locName in locationMap) {
                if (normalize(locName) === normalizedName) {
                    teamRow = locationMap[locName];
                    break;
                }
            }
        }
        
        if (!teamRow) {
            teamsMissingLocation.push(name);
            continue;
        }
        
        const lat = parseFloat(teamRow["Latitude (N‚àò)"] || teamRow["Latitude"] || teamRow["Lat"]);
        const lon = parseFloat(teamRow["Longitude (W‚àò or E‚àò)"] || teamRow["Longitude"] || teamRow["Lon"]);
        const scoreVal = parseFloat(scoreRow.Score);
        const rankVal = scoreRow.Rank || scoreRow["Ranking"] || scoreRow["Rank #"] || scoreRow["#"] || '';

        if (isNaN(lat) || isNaN(lon) || isNaN(scoreVal)) continue;
        
        allTeams.push({
            name,
            lat,
            lon,
            score: scoreVal,
            rank: rankVal,
            location: teamRow["State/Region Context"] || teamRow["State"] || teamRow["Location"] || '',
            rawScoreRow: scoreRow,
            bestSetCol,
            bestTournCol 
        });
    }

    teamsMissingLocationGlobal = teamsMissingLocation;

    if (teamsMissingLocationGlobal.length > 0) {
        console.warn(`
            üö® TEAMS MISSING LOCATION DATA (from Overall Sheet but not found in Location Data Sheet) üö®
            ------------------------------------------------------------------------------------------
            Missing ${teamsMissingLocationGlobal.length} team(s). You need to add coordinates for these in the Location Data sheet.
        `);
        console.log(teamsMissingLocationGlobal); 
    }
    calculateStateRanks();

    const maxScoreLocal = Math.max(...allTeams.map(t => t.score || 0), 0);
    for (const t of allTeams) {
      const radius = computeRadius(t.score, maxScoreLocal); 
      const color = randomColor();
      const popupHTML = makePopupHTML(t);
      const circle = L.circle([t.lat, t.lon], {
        radius,
        color,
        fillColor: color,
        fillOpacity: 0.5,
        weight: 2
      }).addTo(markerLayerGroup).bindPopup(popupHTML);
      circle.bindTooltip(t.name, { permanent: false, direction: 'top' });
      circles.push({ circle, name: t.name, score: t.score, rank: t.rank, lat: t.lat, lon: t.lon, raw: t.rawScoreRow });
    }

    const sorted = [...allTeams].sort((a,b) => {
      const ra = parseInt(a.rank) || 9999999;
      const rb = parseInt(b.rank) || 9999999;
      return ra - rb;
    });
    
    const topRankingsHTML = sorted.map((team, index) => {
      const safeName = team.name.replace(/'/g, "\\'");
      const rnum = `#${team.rank}`; 
      return `<div class="ranking-item" data-team-rank="${team.rank}" data-team-name="${safeName}" onclick="zoomToTeam(${team.lat}, ${team.lon}, '${safeName}')"><span class="ranking-number">${rnum}</span><span class="ranking-team">${team.name}</span><span class="ranking-score">${team.score.toFixed(1)}</span></div>`;
    }).join('');
    
    document.getElementById('topRankings').innerHTML = topRankingsHTML;

    const avgScore = allTeams.reduce((a,b) => a + (b.score||0), 0) / Math.max(allTeams.length,1);
    let statsHTML = `
      <strong>${allTeams.length}</strong> teams loaded<br>
      Top Score: <strong>${(maxScoreLocal||0).toFixed(1)}</strong><br>
      Avg Score: <strong>${avgScore.toFixed(1)}</strong>
    `;
    
    if (teamsMissingLocationGlobal.length > 0) {
        const missingListHTML = teamsMissingLocationGlobal.map(name => `<li>${name}</li>`).join('');

        statsHTML += `<br>
            <span style="color: #f97316; font-weight: bold;">‚ö†Ô∏è ${teamsMissingLocationGlobal.length} missing location data!</span>
            <ul class="missing-teams-list">
                ${missingListHTML}
            </ul>
        `;
    }
    
    document.getElementById('statsSummary').innerHTML = statsHTML;

    document.getElementById('loading').classList.add('hidden');

    filterByRank();

    console.log('Data loading completed.');
  } catch (err) {
    console.error('Error loading data:', err);
    document.getElementById('statsSummary').innerHTML = '<strong>Error loading data!</strong><br>Check console.';
    document.getElementById('loading').classList.add('hidden');
  }
}

function renderCircuitRankings(data, targetId) {
    let tableHTML = `<table class="circuit-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Circuit</th>
                <th>Strength</th>
            </tr>
        </thead>
        <tbody>`;
    
    data.forEach(row => {
        tableHTML += `
            <tr>
                <td>${row.rank}</td>
                <td>${row.circuit}</td>
                <td>${row.strength.toFixed(2)}</td>
            </tr>
        `;
    });

    tableHTML += `</tbody></table>`;
    document.getElementById(targetId).innerHTML = tableHTML;
}

function renderAccolades(data, targetId) {
    const listHTML = data.map(item => `
        <div class="accolade-item">
            <span class="accolade-title">${item.title}</span>
            <span class="accolade-detail">${item.detail}</span>
        </div>
    `).join('');
    document.getElementById(targetId).innerHTML = listHTML;
}

function switchRankingView(view) {
    document.getElementById('overallRankingsContent').classList.add('hidden');
    document.getElementById('hsCircuitRankingsContent').classList.add('hidden');
    document.getElementById('msCircuitRankingsContent').classList.add('hidden');
    document.getElementById('accoladesContent').classList.add('hidden');

    if (view === 'overall') {
        document.getElementById('overallRankingsContent').classList.remove('hidden');
    } else if (view === 'hs_circuit') {
        document.getElementById('hsCircuitRankingsContent').classList.remove('hidden');
    } else if (view === 'ms_circuit') {
        document.getElementById('msCircuitRankingsContent').classList.remove('hidden');
    } else if (view === 'accolades') {
        document.getElementById('accoladesContent').classList.remove('hidden');
    }
}


function makePopupHTML(teamObj) {
  const row = teamObj.rawScoreRow || {};
  const bestSetCol = teamObj.bestSetCol;
  const bestSetVal = bestSetCol ? (row[bestSetCol] || '') : (row['Best Set'] || row['Set'] || '');
  const rankText = teamObj.rank || '';
  
  let stateRankHTML = '';
  if (teamObj.stateRank) {
      stateRankHTML = `<span class="popup-label">State Rank:</span><span class="popup-value">#${teamObj.stateRank} (${teamObj.stateCode})</span>`;
  }

  const popup = 
    `<div class="popup-title">${teamObj.name}</div>
    <div class="popup-stats">
      <span class="popup-label">Score:</span><span class="score-badge">${teamObj.score.toFixed(1)}</span>
      <span class="popup-label">Nat'l Rank:</span><span class="rank-badge">${rankText ? '#' + rankText : '‚Äî'}</span>
      ${stateRankHTML} <span class="popup-label">Location:</span><span class="popup-value">${teamObj.location || '‚Äî'}</span>
      <span class="popup-label">Best Set:</span><span class="popup-value">${bestSetVal || '‚Äî'}</span>
    </div>`;
  return popup;
}

function computeRadius(score, maxScore) {
  const mode = document.getElementById('sizeMode')?.value || 'score';
  let base;
  
  if (mode === 'uniform') {
    base = 10000;
  } else { 
    base = 3000 + ((score / (maxScore || 1)) * 50000);
  }
  
  return base * (radiusMultiplier || 1);
}

function updateSizes() {
  const maxScore = Math.max(...allTeams.map(t=>t.score||0), 0);
  circles.forEach(c => {
    const newRadius = computeRadius(c.score, maxScore); 
    c.circle.setRadius(newRadius);
  });
}

function handleRadiusSlider() {
  const v = parseFloat(document.getElementById('radiusSlider').value);
  radiusMultiplier = v;
  document.getElementById('radiusVal').innerText = v.toFixed(1);
  updateSizes();
}

function randomColor() {
  const colors = ['#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981','#06b6d4','#6366f1','#f43f5e','#14b8a6','#a855f7'];
  return colors[Math.floor(Math.random()*colors.length)];
}
function getColorByRank(rank, maxRank) {
  rank = parseInt(rank) || 999999;
  if (rank <= 10) return '#22c55e';
  if (rank <= 50) return '#3b82f6';
  if (rank <= 100) return '#8b5cf6';
  if (rank <= 500) return '#f59e0b';
  return '#ef4444';
}
function getColorByScore(score, maxScore) {
  const ratio = (maxScore && score) ? score / maxScore : 0;
  if (ratio > 0.8) return '#22c55e';
  if (ratio > 0.6) return '#3b82f6';
  if (ratio > 0.4) return '#8b5cf6';
  if (ratio > 0.2) return '#f59e0b';
  return '#ef4444';
}
function updateColors() {
  const scheme = document.getElementById('colorScheme').value;
  const maxRank = Math.max(...allTeams.map(t => parseInt(t.rank) || 0));
  const maxScore = Math.max(...allTeams.map(t => parseFloat(t.score) || 0));
  circles.forEach(c => {
    let color;
    if (scheme === 'random') color = randomColor();
    else if (scheme === 'rank') color = getColorByRank(c.rank, maxRank);
    else if (scheme === 'score') color = getColorByScore(c.score, maxScore);
    c.circle.setStyle({ color: color, fillColor: color });
  });
}

function togglePanel() {
  document.getElementById('controlPanel').classList.toggle('hidden');
}

function toggleRankingsPanel() {
  const panel = document.getElementById('rankingsPanel');
  panel.classList.toggle('hidden');
}

function toggleDarkMode() {
  const isDark = document.getElementById('darkMode').checked;
  document.body.style.background = isDark ? '#0f172a' : '#f8fafc';
  document.body.style.color = isDark ? '#e2e8f0' : '#0f172a';
  const panels = document.querySelectorAll('.control-panel, .rankings-panel, .loading');
  panels.forEach(panel => {
    if (isDark) {
      panel.style.background = 'linear-gradient(135deg,#1e293b 0%,#0f172a 100%)';
      panel.style.borderColor = 'rgba(59,130,246,0.3)';
      panel.style.color = '#e2e8f0';
    } else {
      panel.style.background = 'linear-gradient(135deg,#ffffff 0%,#f1f5f9 100%)';
      panel.style.borderColor = 'rgba(59,130,246,0.2)';
      panel.style.color = '#0f172a';
    }
  });
  const headings = document.querySelectorAll('.control-panel h2, .rankings-panel h3, .filter-section h4');
  headings.forEach(h => h.style.color = isDark ? '#60a5fa' : '#2563eb');
  const labels = document.querySelectorAll('.control-group label, .popup-label, .checkbox-group label');
  labels.forEach(l => l.style.color = isDark ? '#94a3b8' : '#475569');
  const inputs = document.querySelectorAll('.control-group select, .control-group input, .checkbox-group label');
  inputs.forEach(input => {
    if (isDark) {
      input.style.background = 'rgba(15,23,42,0.8)';
      input.style.color = '#e2e8f0';
      input.style.borderColor = 'rgba(59,130,246,0.3)';
    } else {
      input.style.background = 'white';
      input.style.color = '#0f172a';
      input.style.borderColor = 'rgba(59,130,246,0.3)';
    }
  });

  const rankingTeams = document.querySelectorAll('.ranking-item .ranking-team');
  rankingTeams.forEach(team => {
      team.style.color = isDark ? '#e2e8f0' : '#1e293b';
  });
  
  const popupValues = document.querySelectorAll('.popup-value');
  popupValues.forEach(val => {
      val.style.color = isDark ? '#e2e8f0' : '#1e293b';
  });
  
  const circuitTableCells = document.querySelectorAll('.circuit-table');
  circuitTableCells.forEach(table => {
      table.style.color = isDark ? '#e2e8f0' : '#1e293b'; 
  });
  const circuitTableHeaders = document.querySelectorAll('.circuit-table th');
  circuitTableHeaders.forEach(th => {
      th.style.color = isDark ? '#60a5fa' : '#2563eb';
  });


  createTileLayer(isDark);
}

function filterByRank() {
  const txt = document.getElementById('topX').value;
  const topX = txt ? parseInt(txt) : null;
  let visibleCount = 0;

  circles.forEach((c) => {
    const team = allTeams.find(t => t.name === c.name);
    if (!team) return;
    let rankNum = parseInt(team.rank);
    let shouldShow = false;

    if (!topX || isNaN(rankNum)) {
        shouldShow = true; 
    } else if (rankNum <= topX) {
        shouldShow = true; 
    }

    if (shouldShow) {
      if (!markerLayerGroup.hasLayer(c.circle)) markerLayerGroup.addLayer(c.circle);
      c.circle.setStyle({ opacity:1, fillOpacity:0.5 });
      visibleCount++;
    } else {
      if (markerLayerGroup.hasLayer(c.circle)) markerLayerGroup.removeLayer(c.circle);
    }
  });

  const rankingItems = document.querySelectorAll('#topRankings .ranking-item');
  rankingItems.forEach(item => {
    const rankAttr = item.getAttribute('data-team-rank');
    const rankNum = parseInt(rankAttr);
    
    let showRankingItem = false;
    if (!topX || isNaN(rankNum)) {
        showRankingItem = true;
    } else if (rankNum <= topX) {
        showRankingItem = true;
    }

    item.style.display = showRankingItem ? 'flex' : 'none';
  });
}

function zoomToTeam(lat, lon, teamName) {
  map.setView([lat, lon], 11);
  setTimeout(() => {
    circles.forEach(c => {
      if (c.name === teamName) {
        c.circle.openPopup();
      }
    });
  }, 300);

  const view = document.getElementById('rankingViewSelect').value;
  if (view !== 'overall') return;

  document.querySelectorAll('.ranking-item').forEach(item => {
    item.classList.remove('selected');
  });

  const safeName = teamName.replace(/'/g, "\\'");
  const rankItem = document.querySelector(`#topRankings .ranking-item[data-team-name="${safeName}"]`);
  
  if (rankItem) {
    rankItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
    rankItem.classList.add('selected');
  }

}

let searchTimeout = null;
function handleSearchInput() {
  const el = document.getElementById('teamSearch');
  const q = el.value.trim().toLowerCase();
  const suggestionsDiv = document.getElementById('suggestions');

  document.querySelectorAll('.ranking-item.selected').forEach(item => {
    item.classList.remove('selected');
  });
  circles.forEach(c => c.circle.setStyle({ opacity:1, fillOpacity:0.5 })); 

  if (!q) {
    suggestionsDiv.classList.add('hidden');
    suggestionsDiv.innerHTML = '';
    return;
  }
  
  const matches = allTeams.filter(t => t.name.toLowerCase().includes(q));
  
  if (matches.length === 0) {
    suggestionsDiv.classList.add('hidden');
    suggestionsDiv.innerHTML = '';
    return;
  }
  
  const itemsHTML = matches.map(m => `<div class="suggestion-item" onclick="selectSuggestion('${m.name.replace(/'/g,"\\'")}')">${m.name}</div>`).join('');
  suggestionsDiv.innerHTML = itemsHTML;
  suggestionsDiv.classList.remove('hidden');

  let first = true;
  circles.forEach(c => {
    if (c.name.toLowerCase().includes(q)) {
      c.circle.setStyle({ opacity:1, fillOpacity:0.8 });
      if (first) { map.setView(c.circle.getLatLng(), 9); first = false; }
    } else {
      c.circle.setStyle({ opacity:0.12, fillOpacity:0.05 });
    }
  });

  const rect = el.getBoundingClientRect();
  suggestionsDiv.style.left = (el.offsetLeft) + 'px';
  suggestionsDiv.style.top = (el.offsetTop + el.offsetHeight + 6) + 'px';
  suggestionsDiv.style.width = el.offsetWidth + 'px';
}

function selectSuggestion(name) {
  document.getElementById('teamSearch').value = name;
  document.getElementById('suggestions').classList.add('hidden');
  document.getElementById('suggestions').innerHTML = '';
  const team = allTeams.find(t => t.name === name);
  if (team) zoomToTeam(team.lat, team.lon, team.name);
}

document.addEventListener('click', (e) => {
  const s = document.getElementById('suggestions');
  if (!s) return;
  const wrapper = document.querySelector('.search-wrapper');
  if (!wrapper.contains(e.target)) {
    s.classList.add('hidden');
  }
});

function computeMaxScore() {
  return Math.max(...allTeams.map(t => t.score || 0), 0);
}

window.addEventListener('resize', () => {
  const el = document.getElementById('teamSearch');
  const s = document.getElementById('suggestions');
  if (s && !s.classList.contains('hidden')) {
    s.style.left = el.offsetLeft + 'px';
    s.style.top = (el.offsetTop + el.offsetHeight + 6) + 'px';
  }
});

document.getElementById('radiusVal').innerText = document.getElementById('radiusSlider').value;

function calculateStateRanks() {
  const teamsByState = {};

  allTeams.forEach(team => {
    let state = null;

    const nameMatch = team.name.match(/\(([A-Z]{2})\)/);
    if (nameMatch) {
      state = nameMatch[1];
    } 
    else if (team.location && team.location.length === 2) {
      state = team.location;
    }

    if (state) {
      if (!teamsByState[state]) teamsByState[state] = [];
      teamsByState[state].push(team);
    }
  });

  Object.keys(teamsByState).forEach(state => {
    teamsByState[state].sort((a, b) => b.score - a.score);
    
    teamsByState[state].forEach((team, index) => {
      team.stateRank = index + 1;
      team.stateCode = state;
    });
  });
}
</script>

</body>
</html>
